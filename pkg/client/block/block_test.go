package block_test

import (
	"fmt"
	"testing"

	"github.com/pokt-network/poktroll/pkg/client/block"
	"github.com/stretchr/testify/require"
)

func TestBlockUnmarshaling(t *testing.T) {
	input := `{"jsonrpc":"2.0","result":{"type":"tendermint/event/NewBlock","value":{"block":{"header":{"version":{"block":"11"},"chain_id":"poktroll","height":"82","time":"2024-02-17T00:19:09.544445421Z","last_block_id":{"hash":"79FA15CE124C4FFED03B63FFCFF812FB5FD193DEF75B3C0BCDFABCD5C2F40F9E","parts":{"total":0,"hash":""}},"last_commit_hash":"F9E56DAC16F471EDA67CC83EB448976B9217CF6CD03B86F50AC664586233319E","data_hash":"6E340B9CFFB37A989CA544E6BB780A2C78901D3FB33738768511A30617AFA01D","validators_hash":"","next_validators_hash":"","consensus_hash":"0000000000000000000000000000000000000000000000000000000000000000","app_hash":"84CC1723A585A89DF82FEF562DA7977FCBCEF0DD874C02E2960CD304E6701B97","last_results_hash":"","evidence_hash":"E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855","proposer_address":"12B63B63116782F471FE7FC53E315CE7A87D4283"},"data":{"txs":[]},"evidence":{"evidence":null},"last_commit":{"height":"82","round":0,"block_id":{"hash":"AEA7CED75378A19840D449288BF3571FEF5CF4148F9B78F2026AFF09BE2AEB6E","parts":{"total":0,"hash":""}},"signatures":[{"block_id_flag":2,"validator_address":"12B63B63116782F471FE7FC53E315CE7A87D4283","timestamp":"0001-01-01T00:00:00Z","signature":"IJ9Bgp/35JKm9N+pD1olpNlZt0zWtlpgAGXFp9hfSt4adZ/S7Yd5DAOQzSQu6+Y8Y+BoueLj3o81hmq7C+9PDw=="}]}},"block_id":{"hash":"AEA7CED75378A19840D449288BF3571FEF5CF4148F9B78F2026AFF09BE2AEB6E","parts":{"total":0,"hash":""}},"result_finalize_block":{"events":[{"type":"coin_received","attributes":[{"key":"receiver","value":"pokt1m3h30wlvsf8llruxtpukdvsy0km2kum84hcvmc","index":true},{"key":"amount","value":"1421252190255506upokt","index":true},{"key":"mode","value":"BeginBlock","index":true}]},{"type":"coinbase","attributes":[{"key":"minter","value":"pokt1m3h30wlvsf8llruxtpukdvsy0km2kum84hcvmc","index":true},{"key":"amount","value":"1421252190255506upokt","index":true},{"key":"mode","value":"BeginBlock","index":true}]},{"type":"coin_spent","attributes":[{"key":"spender","value":"pokt1m3h30wlvsf8llruxtpukdvsy0km2kum84hcvmc","index":true},{"key":"amount","value":"1421252190255506upokt","index":true},{"key":"mode","value":"BeginBlock","index":true}]},{"type":"coin_received","attributes":[{"key":"receiver","value":"pokt17xpfvakm2amg962yls6f84z3kell8c5ldlu5h9","index":true},{"key":"amount","value":"1421252190255506upokt","index":true},{"key":"mode","value":"BeginBlock","index":true}]},{"type":"transfer","attributes":[{"key":"recipient","value":"pokt17xpfvakm2amg962yls6f84z3kell8c5ldlu5h9","index":true},{"key":"sender","value":"pokt1m3h30wlvsf8llruxtpukdvsy0km2kum84hcvmc","index":true},{"key":"amount","value":"1421252190255506upokt","index":true},{"key":"mode","value":"BeginBlock","index":true}]},{"type":"message","attributes":[{"key":"sender","value":"pokt1m3h30wlvsf8llruxtpukdvsy0km2kum84hcvmc","index":true},{"key":"mode","value":"BeginBlock","index":true}]},{"type":"mint","attributes":[{"key":"bonded_ratio","value":"0.000000000000013043","index":true},{"key":"inflation","value":"0.130001688975080478","index":true},{"key":"annual_provisions","value":"8970261623841433368300.745675673230815528","index":true},{"key":"amount","value":"1421252190255506","index":true},{"key":"mode","value":"BeginBlock","index":true}]},{"type":"coin_spent","attributes":[{"key":"spender","value":"pokt17xpfvakm2amg962yls6f84z3kell8c5ldlu5h9","index":true},{"key":"amount","value":"1421252190255506upokt","index":true},{"key":"mode","value":"BeginBlock","index":true}]},{"type":"coin_received","attributes":[{"key":"receiver","value":"pokt1jv65s3grqf6v6jl3dp4t6c9t9rk99cd86emg48","index":true},{"key":"amount","value":"1421252190255506upokt","index":true},{"key":"mode","value":"BeginBlock","index":true}]},{"type":"transfer","attributes":[{"key":"recipient","value":"pokt1jv65s3grqf6v6jl3dp4t6c9t9rk99cd86emg48","index":true},{"key":"sender","value":"pokt17xpfvakm2amg962yls6f84z3kell8c5ldlu5h9","index":true},{"key":"amount","value":"1421252190255506upokt","index":true},{"key":"mode","value":"BeginBlock","index":true}]},{"type":"message","attributes":[{"key":"sender","value":"pokt17xpfvakm2amg962yls6f84z3kell8c5ldlu5h9","index":true},{"key":"mode","value":"BeginBlock","index":true}]}],"tx_results":[],"validator_updates":[],"consensus_param_updates":{"block":{"max_bytes":"22020096","max_gas":"-1"},"evidence":{"max_age_num_blocks":"100000","max_age_duration":"172800000000000","max_bytes":"1048576"},"validator":{"pub_key_types":["ed25519"]},"version":{}},"app_hash":"vEq+4rpy5eTTSTkqlLbk8ZdrSLGfCA1rcvsJC6rqi0o="}}},"id":"dSsFXi4p52w="}`

	block := new(block.CometBlockEvent)

	err := block.Unmarshal([]byte(input))
	require.NoError(t, err)

	fmt.Printf("%d, %s\n", block.Height(), block.Hash())
}
