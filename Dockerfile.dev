# This Dockerfile is used to build container image for development purposes.
# It intentionally contains no security features, ships with code and troubleshooting tools.

FROM golang:1.20 as base

RUN apt update && \
    apt-get install -y \
        ca-certificates net-tools kubernetes-client \
        curl jq make vim less dnsutils

# enable faster module downloading.
ENV GOPROXY https://proxy.golang.org

COPY . /poktroll

WORKDIR /poktroll

RUN mv /poktroll/bin/ignite /usr/bin/ && mv /poktroll/bin/poktrolld /usr/bin/

RUN ignite chain init --skip-proto

# Stolen from https://github.com/rollkit/docs/pull/269/files
# copy centralized sequencer address into genesis.json
# Note: validator and sequencer are used interchangeably here
RUN jq --argjson pubKey "$(jq -r '.pub_key' ${HOME}/.poktroll/config/priv_validator_key.json)" --arg address "$(jq -r '.address' ${HOME}/.poktroll/config/priv_validator_key.json)" '. + {"validators": [{"address": $$address, "pub_key": $pubKey, "power": "1000000000000000", "name": "Rollkit Sequencer"}]}' ${HOME}/.poktroll/config/genesis.json > temp.json && mv temp.json ${HOME}/.poktroll/config/genesis.json

# TODO_TECHDEBT(@okdas): Ports are not documented as they will soon be changed with a document to follow
EXPOSE 8545
EXPOSE 8546
EXPOSE 8547
EXPOSE 8548

ENTRYPOINT ["ignite"]
